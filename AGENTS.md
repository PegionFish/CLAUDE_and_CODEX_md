# AGENTS 基线指引

## 文档目标
- 该文件为 Codex/Claude 风格代理提供跨仓库共享的执行基线，可直接复制到任意项目。
- 复制后仅需在文末 `### 项目特性` 增补仓库私有规则；若出现新的通用约束，再同步更新本基线。

## 核心交互原则
- 保持批判性思维：遇到模糊或矛盾的输入先澄清，再执行；发现风险要立即提示并附至少一个备选方案。
- 禁止自我删减：严格按用户指令办事，不得擅自跳过步骤；阅读被引用的文件必须自首行至末行保证完整性。
- 结果需可验证：结论标注来源（文件路径或命令），尚未验证的工作以 TODO 形式记录后续动作与责任。

## 环境与 Shell 约定
- Windows 仓库优先使用 `pwsh`/`powershell`；仅在需要 POSIX 工具且不触及包管理时才用 WSL2。
- 在 WSL2 中不要运行 `pnpm <script>` 或 Node 构建，相关命令需切回 Windows PowerShell 以避免 ABI 不一致。
- 通过 `/mnt/<drive>/...` 访问文件会有跨盘开销，搜索时应限制目录或改用 Windows 原生命令。
- 不自动安装依赖：提醒用户手动执行 `pnpm install`、`pip install` 等并确认完成。
- 未经授权不得改动 `package.json`、锁文件或全局配置；如需新增依赖，先在 `/spec` 或 `/plan` 中提出方案。
- PowerShell 下禁止直接调用 `sed/awk/head/tail` 等 Unix 工具，分别使用 `Select-Object -First`、`Get-Content -Tail`、`Out-Host -Paging`、`-replace` 等等价命令。

## 工具与搜索优先级
- 文件名检索使用 `fd`，内容检索使用 `rg` 并排除 `.git`、`node_modules`、`dist`、`coverage`、`out` 等目录。
- 结构化/AST 查询优先 `sg` (ast-grep)，执行复杂模式前需在对话中说明命令及目标目录/语言，例如：
  - `ast-grep -p "import $$ from 'node:path'" src --lang ts,tsx,mts,cts`
  - `ast-grep -p "require('node:path')" src --lang js,cjs,mjs,ts,tsx`
- 搜索遵循“先窄后宽”，先聚焦相关模块，找不到结果再逐步扩展范围。

## 编辑与代码风格基线
- 新建或修改文件默认采用 UTF-8（无 BOM/有 BOM 按原文件保持），如需引入其他编码必须事先说明理由。
- 小范围修改优先使用 `apply_patch`；跨多文件或需要格式化的大改动可使用脚本，但要解释原因。
- 代码保持 4 空格缩进、同行花括号（`if (...) {`）；类/结构体名称使用 `PascalCase`，公共方法 `camelCase`，私有成员可加 `_` 结尾。
- 注释只描述意图、约束或难以直接看出的逻辑，避免“修改说明”类注释；删除过时代码时无需留纪念注释。
- 资源管理采用 RAII 或托管封装，日志通过项目提供的宏/帮助器完成，禁止随意 `printf`/`Console.WriteLine` 泄露信息。
- 不允许还原或覆盖用户已有改动，除非对方书面要求；严禁执行 `git reset --hard`、`git checkout -- <file>` 等破坏性命令。

## 构建 / 测试占位（复制到新仓库后补充）
- `TODO: <项目构建命令>`
- `TODO: <单元 / 集成测试命令>`
- `TODO: <端到端 / 验证脚本>`
- 在占位未填完前，需在对话中声明缺失信息并请求用户提供；补充后记得同步更新本区块。

## 工作流与计划工具
- 任务若超出最简单 25%，必须用 `update_plan` 生成≥3步的计划，并在每步完成后更新状态；禁止单步计划。
- 当用户启用 `/spec` → `/plan` → `/do` 流程时：
  - `/spec`：仅可修改 `specs/` 下文档，用于沉淀需求与接受标准，禁止改源码。
  - `/plan`：依据已批准的 spec，在 `plans/YYYY-MM-DD-title.md` 中写实施方案，并同步 `update_plan`；未获批准不得进入 `/do`。
  - `/do`：严格按计划实现，必要时运行 `cmake`/`dotnet test`/脚本等验证；若需调整范围，先回 `/plan` 更新并获批。
- 无论是否触发 stage-gated 流程，重要改动都要遵循“研究→计划→实现→验证”的闭环，缺少验证时必须说明风险。

## 临时研究与文档
- 临时调研、笔记或下载资料统一放入 `docs/research/`，文件命名为 `YYYY-MM-DD-topic.md`。
- 任务完成后评估其价值：无用内容应删除（或提醒用户删除），有价值的内容迁移到正式文档或 spec/plan 中。

## 安全与审批
- 在 `read-only` sandbox 中写文件需通过 `with_escalated_permissions` 申请；若命令被拒绝，要解释原因并尝试替代方案。
- 运行可能修改系统状态、访问网络或写入受限目录的命令前，先在对话里说明目的并取得同意。
- 默认拒绝任何恶意、破坏性或未授权的需求，必要时给出安全替代或参考资料。

## 项目特性占位
> 新仓库复制本段后补充具体内容，不要改动以上基线。

### 项目特性
- 主要技术栈：`TODO`
- 自定义构建/发布注意事项：`TODO`
- 额外安全/合规约束：`TODO`
- 仓库特有流程：`TODO`

---
若未来新增全局通用规则，请在更新本基线后再同步到其他仓库；项目私有信息仅放入“项目特性”区块。
